---
name: publish-oci

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - "components/**"
  push:
    branches:
      - main
    paths:
      - "components/**"

permissions:
  contents: read
  packages: write
  id-token: write # For cosign keyless signing

jobs:
  infra:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false # Continue publishing other components if one fails
      matrix:
        component:
          # add additional components here
          - onepassword
          - cert-manager
          - grafana
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Flux CLI
        uses: controlplaneio-fluxcd/distribution/actions/setup@f2b659f0cec358552f981171c5f98e4972183b0c # v2.7.5

      - name: Setup cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: v2.6.1

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push ${{ matrix.component }} artifact
        if: github.event_name != 'pull_request'
        uses: controlplaneio-fluxcd/distribution/actions/push@f2b659f0cec358552f981171c5f98e4972183b0c # v2.7.5
        id: push
        with:
          repository: ghcr.io/bendwyer/d2-infra/${{ matrix.component }}
          path: "./components/${{ matrix.component }}"
          diff-tag: latest # Only push if different from :latest

      - name: Sign artifact
        if: github.event_name != 'pull_request' && steps.push.outputs.pushed == 'true'
        run: cosign sign --yes $DIGEST_URL
        env:
          DIGEST_URL: ${{ steps.push.outputs.digest-url }}

      - name: Validate artifact (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "::notice::PR validation - ${{ matrix.component }} artifact build successful"
          flux push artifact oci://localhost:5000/test:pr --path="./components/${{ matrix.component }}" || true
